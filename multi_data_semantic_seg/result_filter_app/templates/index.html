<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Result Filter — Compare & Judge</title>
  <style>
    :root {
      --bg: #1a1b1e;
      --surface: #25262b;
      --border: #3d3f44;
      --text: #e8e8e8;
      --accent: #4dabf7;
      --pass: #51cf66;
      --fail: #ff6b6b;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1rem 2rem;
      min-height: 100vh;
    }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    .toolbar {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    label { margin-right: 0.5rem; }
    select {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      min-width: 220px;
    }
    button {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { filter: brightness(1.1); }
    button.pass { background: var(--pass); }
    button.fail { background: var(--fail); }
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.75rem;
      margin-bottom: 2rem;
    }
    .preview-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .preview-card:hover { border-color: var(--accent); }
    .preview-card .thumb {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      display: block;
    }
    .preview-card .meta {
      padding: 0.4rem 0.5rem;
      font-size: 0.7rem;
      line-height: 1.3;
    }
    .preview-card .meta .score { color: var(--accent); }
    .preview-card .badge {
      position: absolute;
      top: 4px;
      right: 4px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 700;
    }
    .preview-card .badge.pass { background: var(--pass); color: var(--bg); }
    .preview-card .badge.fail { background: var(--fail); color: var(--bg); }
    .compare-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    .compare-modal h2 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .compare-modal .pane {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 100%;
      margin: 0.5rem 0 1rem;
    }
    .compare-modal .pane figure {
      margin: 0;
      text-align: center;
    }
    .compare-modal .pane img {
      max-width: min(45vw, 520px);
      max-height: 60vh;
      object-fit: contain;
      border: 2px solid var(--border);
      border-radius: 6px;
    }
    .compare-modal .pane figcaption {
      font-size: 0.75rem;
      margin-top: 0.25rem;
      color: #999;
    }
    .compare-modal .actions {
      display: flex;
      gap: 1rem;
    }
    .compare-modal .actions button { min-width: 100px; }
    .compare-modal .progress {
      font-size: 0.8rem;
      color: #999;
      margin-top: 0.5rem;
    }
    .empty { color: #666; padding: 2rem; }
  </style>
</head>
<body>
  <h1>Result Filter — Compare & Judge</h1>
  <div class="toolbar">
    <label for="imageSelect">Image</label>
    <select id="imageSelect"></select>
    <label for="instanceSelect">Instance type</label>
    <select id="instanceSelect">
      <option value="nCnI">nCnI</option>
      <option value="1CnI">1CnI</option>
    </select>
    <button type="button" id="btnCompareEach">Compare each (pop)</button>
  </div>
  <div id="previewContainer" class="preview-grid"></div>
  <div id="compareModal" class="compare-modal" style="display: none;">
    <h2 id="compareTitle">Compare</h2>
    <div class="pane">
      <figure>
        <img id="comparePred" alt="Prediction" />
        <figcaption>Prediction — <span id="comparePredLabel"></span></figcaption>
      </figure>
      <figure>
        <img id="compareGt" alt="Ground truth" />
        <figcaption>Ground truth</figcaption>
      </figure>
    </div>
    <div class="actions">
      <button class="pass" type="button" id="btnPass">Pass</button>
      <button class="fail" type="button" id="btnFail">No</button>
    </div>
    <div class="progress" id="compareProgress"></div>
  </div>

  <script>
    const imageSelect = document.getElementById('imageSelect');
    const instanceSelect = document.getElementById('instanceSelect');
    const previewContainer = document.getElementById('previewContainer');
    const compareModal = document.getElementById('compareModal');
    const compareTitle = document.getElementById('compareTitle');
    const comparePred = document.getElementById('comparePred');
    const comparePredLabel = document.getElementById('comparePredLabel');
    const compareGt = document.getElementById('compareGt');
    const compareProgress = document.getElementById('compareProgress');
    const btnCompareEach = document.getElementById('btnCompareEach');
    const btnPass = document.getElementById('btnPass');
    const btnFail = document.getElementById('btnFail');

    let images = [];
    let analysis = [];
    let currentPreds = [];
    let currentGt = null;
    let compareIndex = 0;

    function maskUrl(filename) {
      return '/files/masks/' + encodeURIComponent(filename);
    }

    async function fetchJson(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error(r.statusText);
      return r.json();
    }

    async function loadImages() {
      images = await fetchJson('/api/images');
      try {
        const a = await fetchJson('/api/analysis');
        analysis = Array.isArray(a) ? a : (a.by_image_instance || []);
      } catch (_) {
        analysis = [];
      }
      imageSelect.innerHTML = '';
      const order = new Map();
      analysis.forEach((x, i) => { if (!order.has(x.image_id)) order.set(x.image_id, i); });
      const imageKeys = [...new Set(images.map(i => i.id))];
      if (order.size) imageKeys.sort((a, b) => (order.get(a) ?? 9999) - (order.get(b) ?? 9999));
      imageKeys.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = id;
        imageSelect.appendChild(opt);
      });
      if (imageSelect.selectedIndex < 0 && imageKeys.length) imageSelect.selectedIndex = 0;
    }

    async function loadAnnotations() {
      const imageId = imageSelect.value;
      const instanceType = instanceSelect.value;
      if (!imageId) return;
      const data = await fetchJson('/api/annotations?image_id=' + encodeURIComponent(imageId) + '&instance_type=' + encodeURIComponent(instanceType));
      currentPreds = data.predictions || [];
      currentGt = data.gt || null;
      renderPreview();
    }

    function predMaskPath(ann) {
      const preds = ann.predictions || [];
      return preds[0] && preds[0].file_path ? preds[0].file_path : null;
    }

    function renderPreview() {
      previewContainer.innerHTML = '';
      if (!currentPreds.length) {
        previewContainer.innerHTML = '<p class="empty">No predictions for this image + instance type.</p>';
        return;
      }
      currentPreds.forEach((ann, i) => {
        const path = predMaskPath(ann);
        const card = document.createElement('div');
        card.className = 'preview-card';
        card.dataset.index = String(i);
        const label = [ann.model_name, ann.augmentation].filter(Boolean).join(' · ') || ann.model_name;
        const score = ann.final_score != null ? (ann.final_score * 100).toFixed(2) + '%' : '—';
        const judgment = ann.user_judgment;
        card.innerHTML =
          (judgment ? '<span class="badge ' + judgment + '">' + judgment + '</span>' : '') +
          '<img class="thumb" src="' + (path ? maskUrl(path) : '') + '" alt="" loading="lazy" />' +
          '<div class="meta">' +
          '<span class="score">#' + (i + 1) + ' ' + score + '</span><br/>' + label +
          '</div>';
        card.addEventListener('click', () => openCompare(i));
        previewContainer.appendChild(card);
      });
    }

    function openCompare(index) {
      compareIndex = index;
      showCompareModal();
    }

    function showCompareModal() {
      const ann = currentPreds[compareIndex];
      if (!ann) return;
      const path = predMaskPath(ann);
      const gtPath = currentGt && currentGt.predictions && currentGt.predictions[0] ? currentGt.predictions[0].file_path : null;
      comparePredLabel.textContent = [ann.model_name, ann.augmentation].filter(Boolean).join(' · ') || ann.model_name;
      comparePred.src = path ? maskUrl(path) : '';
      compareGt.src = gtPath ? maskUrl(gtPath) : '';
      compareTitle.textContent = 'Compare — ' + (compareIndex + 1) + ' / ' + currentPreds.length;
      compareProgress.textContent = 'Annotation ID: ' + (ann.id || '') + ' — Choose Pass or No';
      compareModal.style.display = 'flex';
    }

    async function submitJudge(judgment) {
      const ann = currentPreds[compareIndex];
      if (!ann || !ann.id) return;
      try {
        const r = await fetch('/api/judge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ annotation_id: ann.id, user_judgment: judgment })
        });
        const data = await r.json();
        if (data.ok) {
          ann.user_judgment = judgment;
          renderPreview();
        }
      } catch (e) {
        console.error(e);
      }
      compareIndex++;
      if (compareIndex < currentPreds.length) {
        showCompareModal();
      } else {
        compareModal.style.display = 'none';
      }
    }

    btnCompareEach.addEventListener('click', () => {
      if (!currentPreds.length) return;
      compareIndex = 0;
      openCompare(0);
    });
    btnPass.addEventListener('click', () => submitJudge('pass'));
    btnFail.addEventListener('click', () => submitJudge('fail'));

    imageSelect.addEventListener('change', loadAnnotations);
    instanceSelect.addEventListener('change', () => { loadImages().then(loadAnnotations); });

    loadImages().then(loadAnnotations);
  </script>
</body>
</html>
